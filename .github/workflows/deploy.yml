name: Deploy CallCenterAI to Production

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  DROPLET_ID: "547983969"
  SERVER_IP: "64.23.152.92"

jobs:
  build-go-tools:
    name: Build Go Deployment Tools
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Set up Go 1.24
      uses: actions/setup-go@v4
      with:
        go-version: '1.24'

    - name: Build deployment binaries
      working-directory: ./deployment
      run: |
        echo "ğŸ”¨ Compilando herramientas Go para deployment..."
        go mod download
        go build -o bin/deploy ./cmd/deploy/main.go
        go build -o bin/healthcheck ./cmd/healthcheck/main.go
        echo "âœ… Binarios compilados:"
        ls -lh bin/
        file bin/deploy
        file bin/healthcheck

    - name: Test healthcheck tool
      working-directory: ./deployment
      run: |
        echo "ğŸ§ª Probando herramienta de health check..."
        ./bin/healthcheck -endpoint=http://${{ env.SERVER_IP }}:8000/health || echo "âš ï¸ Pre-deploy check (esperado)"

  deploy-to-digitalocean:
    name: Deploy to DigitalOcean Droplet
    runs-on: ubuntu-latest
    needs: build-go-tools
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy via SSH to Droplet ${{ env.DROPLET_ID }}
      uses: appleboy/ssh-action@master
      with:
        host: ${{ env.SERVER_IP }}
        username: root
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 300s
        script: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         ğŸš€ CALLCENTERAI - DESPLIEGUE AUTOMÃTICO               â•‘"
          echo "â•‘         Droplet ID: ${{ env.DROPLET_ID }}                     â•‘"
          echo "â•‘         Timestamp: $(date)                                     â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          cd /root/FullProject
          
          echo "ğŸ“¥ [1/6] Actualizando cÃ³digo desde GitHub..."
          git pull origin main || git pull origin master
          
          echo "ğŸ›‘ [2/6] Deteniendo contenedores actuales..."
          docker compose down
          
          echo "ğŸ§¹ [3/6] Limpiando recursos Docker..."
          docker system prune -f --volumes
          
          echo "ğŸ”¨ [4/6] Reconstruyendo imÃ¡genes Docker..."
          docker compose build --no-cache --pull
          
          echo "ğŸš€ [5/6] Iniciando servicios..."
          docker compose up -d
          
          echo "â³ [6/6] Esperando inicializaciÃ³n de servicios..."
          sleep 20
          
          echo "ğŸ“Š Estado final de contenedores:"
          docker compose ps
          
          echo "ğŸ“ Logs recientes del backend:"
          docker compose logs --tail=30 fastapi_backend
          
          echo "âœ… â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… DESPLIEGUE COMPLETADO EXITOSAMENTE"
          echo "âœ… â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  verify-deployment:
    name: Verify Production Health
    runs-on: ubuntu-latest
    needs: deploy-to-digitalocean
    
    steps:
    - name: Wait for services to stabilize
      run: sleep 15

    - name: Health Check - Backend API
      run: |
        echo "ğŸ¥ Verificando salud del backend..."
        response=$(curl -s -w "\n%{http_code}" http://${{ env.SERVER_IP }}:8000/health)
        status=$(echo "$response" | tail -n1)
        body=$(echo "$response" | head -n-1)
        
        if [ "$status" -eq 200 ]; then
          echo "âœ… Backend saludable (HTTP $status)"
          echo "$body"
        else
          echo "âŒ Backend no responde correctamente (HTTP $status)"
          exit 1
        fi

    - name: Health Check - Widget Endpoint
      run: |
        echo "ğŸ§© Verificando widget..."
        curl -f http://${{ env.SERVER_IP }}:8000/widget && echo "âœ… Widget accesible" || echo "âš ï¸ Widget no disponible"

    - name: Final Deployment Report
      if: always()
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“Š REPORTE DE DESPLIEGUE"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸŒ Sitio Web: https://www.engine-tecai.me"
        echo "ğŸ”— API: https://api.engine-tecai.me"
        echo "ğŸ§© Widget: https://api.engine-tecai.me/widget"
        echo "ğŸ“ˆ Prometheus: http://${{ env.SERVER_IP }}:9090"
        echo "ğŸ“Š Grafana: http://${{ env.SERVER_IP }}:3001"
        echo "â° Timestamp: $(date)"
        echo "âœ… Commit: ${{ github.sha }}"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
