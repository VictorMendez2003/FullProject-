name: Deploy to DigitalOcean

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: Build deployment tools
      working-directory: ./deployment
      run: |
        go mod download
        go build -o bin/deploy ./cmd/deploy/main.go
        go build -o bin/healthcheck ./cmd/healthcheck/main.go
        chmod +x bin/deploy bin/healthcheck
    
    - name: Deploy to DigitalOcean
      env:
        DO_API_TOKEN: ${{ secrets.DO_API_TOKEN }}
        DROPLET_ID: ${{ secrets.DROPLET_ID }}
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      run: |
        echo "ðŸš€ Iniciando deployment a DigitalOcean..."
        
        # Configurar SSH
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H 64.23.152.92 >> ~/.ssh/known_hosts
        
        # Copiar archivos al servidor
        echo "ðŸ“¦ Copiando archivos..."
        scp -r Backend_Agente_Inteligente root@64.23.152.92:/root/FullProject/
        scp -r FrontendCallCenterRN root@64.23.152.92:/root/FullProject/
        scp docker-compose.yml root@64.23.152.92:/root/FullProject/
        
        # Ejecutar deployment en el servidor
        echo "ðŸ”„ Ejecutando deployment..."
        ssh root@64.23.152.92 << 'ENDSSH'
          cd /root/FullProject
          
          # Pull de cambios en repositorios
          cd Backend_Agente_Inteligente && git pull origin main
          cd ../FrontendCallCenterRN && git pull origin master
          cd ..
          
          # Rebuild y restart de contenedores
          docker-compose down
          docker-compose build --no-cache
          docker-compose up -d
          
          # Esperar a que los servicios inicien
          echo "â³ Esperando servicios..."
          sleep 15
          
          # Verificar estado
          docker-compose ps
          docker logs fastapi_backend --tail 20
ENDSSH
    
    - name: Health Check
      run: |
        echo "ðŸ¥ Verificando health del backend..."
        sleep 10
        curl -f http://64.23.152.92:8000/health || exit 1
        echo "âœ… Deployment exitoso!"
    
    - name: Notify Success
      if: success()
      run: |
        echo "âœ… Deployment completado exitosamente"
        echo "ðŸŒ Backend: http://64.23.152.92:8000"
        echo "ðŸ“± Frontend: http://64.23.152.92:3000"
    
    - name: Notify Failure
      if: failure()
      run: |
        echo "âŒ Deployment fallÃ³ - revisar logs"
